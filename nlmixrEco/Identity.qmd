## Requirements

I would encourage you to go through this exercise:\
\
1) Generate a set of "perfect" PK data (central compartment concentration only) by simulating a two-compartment model. For the sake of simplicity, do not add noise to the data. So you know the true parameter values.\
2) Fit the data to a two-compartment model using the FME package - can you recover the true parameter values?\
3) Using FME, calculate the collinearity for pairs / groups of parameters. Are they collinear?\
4) Perform MCMC simulation with FME - can you recover the true parameter values? Are parameters all identifiable?\

```{r}
# step one

## load the required libraries
library(nlmixr2)
library(rxode2)

library(lattice)
library(gridExtra)
######################################################################
## Simulation of a single (warfarin concentration) curve with a single dose    ##
##                                                                             ##
#################################################################################

## set up the system of differential equations (ODEs)
odeKA1 <- "
 d/dt(depot)   = -ka*depot;
 d/dt(central) =  ka*depot-(cl/v)*central;
 C1=central/v;
"

## compile the model
modKA1 <- rxode2(model = odeKA1)

## provide the parameter values to be simulated:
Params <- c(
 ka = log(2) / 3, # 1/h (aborption half-life of 3 hours)
 cl = 0.135,        # L/h
 v = 8              # L
)

## create an empty event table that stores both dosing and sampling information :
ev <- eventTable()

## add a dose to the event table:
ev$add.dosing(dose = 500) #mg
              
## add time points to the event table where concentrations will be simulated; these actions are cumulative
ev$add.sampling(seq(0, 24, 2))

## Then solve the system
##
## The output from rxSolve is a solved RxODE object,
##  but by making it a data.frame only the simulated values are kept:
Res<-data.frame(rxSolve(modKA1,Params,ev))

## then plot the simulated outcomes in the compartments:
## the amounts in the depot compartment
p1 <- xyplot(depot~time,data=Res,type='l',lwd=2, main = "depot compartment")
## the concentrations in the central compartment
p2 <- xyplot(C1~time,data=Res,type='l',lwd=2, main = "central compartment")

grid.arrange(p1,p2, ncol = 2)

```

```{r}
# step two 
# fit simulated data with FME.

library(FME)

#log

DatalogC <- data_frame(
    time = Res$time,
    logC = log(Res$C1+1),
    sd = 0.2
)

DataLogD <- data_frame(
    time = Res$time,
    logD = log(Res$depot+1),
    sd = 0.2
)
```
